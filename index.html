<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Rastreador AN-32B | Navegación Perú</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <script src="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Widgets/widgets.css" rel="stylesheet"/>

  <style>
    html, body, #cesiumContainer { width:100%; height:100%; margin:0; padding:0; overflow:hidden; background: #000; }

    #hud {
      position: absolute;
      z-index: 9999;
      background: rgba(0,0,0,0.9);
      color: #00ff41; 
      padding: 15px;
      border: 1px solid #00ff41;
      font: 12px 'Courier New', monospace;
      box-shadow: 0 0 20px rgba(0,255,65,0.3);
      transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), bottom 0.3s, left 0.3s;
      cursor: pointer;
      user-select: none;
    }

    #hud.zoomed {
      transform: scale(1.3);
      transform-origin: bottom left;
      background: rgba(0,20,0,0.95);
      border-width: 2px;
    }

    @media (min-width: 768px) {
      #hud { top: 10px; left: 10px; width: 300px; border-radius: 8px; }
      #hud.zoomed { transform-origin: top left; }
    }

    @media (max-width: 767px) {
      #hud { bottom: 0; left: 0; right: 0; width: 100%; border-radius: 20px 20px 0 0; border:none; border-top: 2px solid #00ff41; }
      #hud.zoomed { transform: scale(1.1) translateY(-10px); transform-origin: bottom center; }
      .hud-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    }

    #terrainAlert {
      display: none; color: #ff4444; font-weight: bold; text-align: center;
      border: 1px solid #ff4444; padding: 4px; margin-top: 5px; animation: blink 0.6s infinite;
    }

    @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.2; } 100% { opacity: 1; } }
    #dot { display:inline-block; width:8px; height:8px; border-radius:50%; margin-right:5px; background:#ff4444; }
    .label { color: #00ff41; text-transform: uppercase; font-size: 9px; opacity: 0.7; display: block; }
    .stat { color: #fff; font-weight: bold; font-size: 14px; }
    hr { border: 0; border-top: 1px solid rgba(0,255,65,0.3); margin: 8px 0; }
    .unit { font-size: 9px; color: #00ff41; margin-left: 2px; }
    .nav-dest { color: #00e5ff !important; font-size: 11px; }
  </style>
</head>

<body>
  <div id="hud" onclick="this.classList.toggle('zoomed')">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <span><span id="dot"></span> <span id="linkStatus" style="font-size: 10px;">GPS BUSCANDO...</span></span>
      <span id="last" style="font-size:9px; opacity:0.6">--:--:--</span>
    </div>
    
    <hr>
    
    <div class="hud-grid">
      <div class="info-block">
        <span class="label">Radar Alt (AGL)</span>
        <span id="agl" class="stat">--</span><span class="unit">FT</span>
      </div>
      <div class="info-block">
        <span class="label">V. Speed (VSI)</span>
        <span id="vsi" class="stat">--</span><span class="unit">FPM</span>
      </div>
      <div class="info-block">
        <span class="label">MSL Altitude</span>
        <span id="altft" class="stat">--</span><span class="unit">FT</span>
      </div>
      <div class="info-block">
        <span class="label">Ground Speed</span>
        <span id="spd" class="stat">--</span><span class="unit">KM/H</span>
      </div>
    </div>

    <div id="terrainAlert">⚠️ LOW TERRAIN ⚠️</div>
    
    <hr>

    <div class="hud-grid">
      <div class="info-block">
        <span class="label">Prox. Destino</span>
        <span id="dest-name" class="stat nav-dest">BUSCANDO...</span>
      </div>
      <div class="info-block">
        <span class="label">DME (Distancia)</span>
        <span id="dme" class="stat">--</span><span class="unit">NM</span>
      </div>
      <div class="info-block" style="grid-column: span 2;">
        <span class="label">ETA (Tiempo Estimado)</span>
        <span id="eta" class="stat">--</span><span class="unit">MINUTOS</span>
      </div>
    </div>

    <hr>
    
    <div style="font-size: 9px; line-height: 1.4;">
      <span id="env" style="color: #fff; display:block;">ESPERANDO ATMÓSFERA...</span>
      <span class="label">Weather: <span id="wx200" style="color: #fff; text-transform: none;">--</span></span>
    </div>
    <div style="text-align: center; font-size: 8px; opacity: 0.4; margin-top: 5px;">[ TOCAR PARA ZOOM ]</div>
  </div>

  <div id="cesiumContainer"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const WEATHER_POLL_MS = 60000;
    Cesium.Ion.defaultAccessToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIyMWEwZTAwZS0wYWVjLTQ1ZmUtOGY2OC05NmVjZmQ5OTNhZTEiLCJpZCI6Mzg2Nzc5LCJpYXQiOjE3NzAxNzUzMDB9.Myivn9P57mAFArlOhP_dXj-CmANbGiUnwmTXssotP_o";

    const firebaseConfig = {
      apiKey: "AIzaSyCDHpTxxw0XObZFaG4G7VRVl8-ouszM5e8",
      authDomain: "tracker-an32b.firebaseapp.com",
      databaseURL: "https://tracker-an32b-default-rtdb.firebaseio.com",
      projectId: "tracker-an32b",
    };

    // AEROPUERTOS PERÚ
    const AEROPUERTOS = [
      { name: "BASE DIRAVPOL", lat: -12.0219, lon: -77.1143 },
      { name: "SPJC (LIMA)", lat: -12.0219, lon: -77.1143 },
      { name: "SPZO (CUSCO)", lat: -13.5357, lon: -71.9387 },
      { name: "SPQU (AREQUIPA)", lat: -16.3411, lon: -71.5831 },
      { name: "SPQT (IQUITOS)", lat: -3.7847, lon: -73.3088 },
      { name: "SPUR (PIURA)", lat: -5.2056, lon: -80.6164 },
      { name: "SPHI (PUCALLPA)", lat: -8.3781, lon: -74.5741 }
    ];

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const hud = {
        link: document.getElementById("linkStatus"),
        terrainAlert: document.getElementById("terrainAlert"),
        wx: document.getElementById("wx200"),
        spd: document.getElementById("spd"),
        altft: document.getElementById("altft"),
        agl: document.getElementById("agl"),
        vsi: document.getElementById("vsi"),
        env: document.getElementById("env"),
        last: document.getElementById("last"),
        dme: document.getElementById("dme"),
        eta: document.getElementById("eta"),
        dest: document.getElementById("dest-name")
    };

    const viewer = new Cesium.Viewer("cesiumContainer", {
      terrain: Cesium.Terrain.fromWorldTerrain(),
      timeline: false, animation: false, shadows: true,
      navigationHelpButton: false, sceneModePicker: false, fullscreenButton: false
    });

    const plane = viewer.entities.add({
      label: { text: "AN-32B", font: "10px monospace", pixelOffset: new Cesium.Cartesian2(0, -15) },
      point: { pixelSize: 8, color: Cesium.Color.RED }
    });
    viewer.trackedEntity = plane;

    let trailPoints = [];
    viewer.entities.add({
      polyline: {
        positions: new Cesium.CallbackProperty(() => trailPoints, false),
        width: 3, material: new Cesium.PolylineGlowMaterialProperty({ color: Cesium.Color.RED, glowPower: 0.1 })
      }
    });

    // Función Matemática para DME (Haversine)
    function getDistanceNM(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return (R * c) * 0.539957; // De KM a Millas Náuticas
    }

    // TRANSMISOR GPS
    navigator.geolocation.watchPosition(
      pos => {
        set(ref(db, "an32/position"), {
          lat: pos.coords.latitude,
          lon: pos.coords.longitude,
          alt: pos.coords.altitude || 1000,
          time: Date.now()
        });
      },
      err => { hud.link.textContent = "GPS ERR"; },
      { enableHighAccuracy: true }
    );

    let lastFix = null;
    let lastWxAt = 0;

    async function fetchAtmosphere(lat, lon) {
        if (Date.now() - lastWxAt < WEATHER_POLL_MS) return;
        lastWxAt = Date.now();
        try {
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=weather_code,precipitation,wind_speed_10m,wind_direction_10m,surface_pressure`;
            const res = await fetch(url);
            const data = await res.json();
            const c = data.current;
            hud.wx.textContent = `${c.precipitation.toFixed(1)}mm`;
            hud.env.textContent = `WND: ${c.wind_speed_10m}km/h @ ${c.wind_direction_10m}°`;
        } catch (e) { }
    }

    onValue(ref(db, "an32/position"), (snap) => {
      const d = snap.val();
      if (!d) return;
      const pos = Cesium.Cartesian3.fromDegrees(d.lon, d.lat, d.alt);
      plane.position = pos;
      trailPoints.push(pos);
      if(trailPoints.length > 500) trailPoints.shift();

      let currentSpeedKMH = 0;

      if (lastFix) {
          const dt = (Date.now() - lastFix.time) / 1000;
          const distMeters = Cesium.Cartesian3.distance(Cesium.Cartesian3.fromDegrees(lastFix.lon, lastFix.lat), Cesium.Cartesian3.fromDegrees(d.lon, d.lat));
          currentSpeedKMH = (distMeters / dt) * 3.6;
          hud.spd.textContent = currentSpeedKMH.toFixed(1);
          
          const vsi = ((d.alt - lastFix.alt) * 3.28084) / (dt / 60);
          hud.vsi.textContent = (vsi > 0 ? "+" : "") + vsi.toFixed(0);
      }

      // --- LÓGICA DE NAVEGACIÓN ---
      let nearest = AEROPUERTOS[0];
      let minDist = 999999;

      AEROPUERTOS.forEach(ap => {
          const dist = getDistanceNM(d.lat, d.lon, ap.lat, ap.lon);
          if(dist < minDist) { minDist = dist; nearest = ap; }
      });

      hud.dest.textContent = nearest.name;
      hud.dme.textContent = minDist.toFixed(1);

      // Calcular ETA (Minutos)
      if (currentSpeedKMH > 20) {
          const speedKnots = currentSpeedKMH / 1.852;
          const etaMin = (minDist / speedKnots) * 60;
          hud.eta.textContent = Math.round(etaMin);
      } else {
          hud.eta.textContent = "N/A";
      }

      hud.altft.textContent = (d.alt * 3.28084).toFixed(0);
      hud.last.textContent = new Date().toLocaleTimeString();
      
      fetchAtmosphere(d.lat, d.lon);
      lastFix = { lat: d.lat, lon: d.lon, alt: d.alt, time: Date.now() };
      hud.link.textContent = "GPS ONLINE";
    });
  </script>
</body>
</html>