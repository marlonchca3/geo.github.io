<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>GPS AN-32B</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

  <!-- Leaflet (mapa liviano) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body{ margin:0; background:#fff; color:#111; }
    header{ padding:16px 16px 8px; font-family:Georgia, "Times New Roman", serif; }
    h2{ margin:0; font-size:40px; font-weight:700; }
    #status{ padding:8px 16px 12px; font-size:22px; line-height:1.25; font-family:Georgia, "Times New Roman", serif; }

    /* √°rea ‚Äúen blanco‚Äù => mapa */
    #wrap{ padding:0 14px 16px; }
    #map{
      width:100%;
      height:52vh;
      min-height:320px;
      border-radius:18px;
      overflow:hidden;
      box-shadow:0 10px 30px rgba(0,0,0,.15);
      position:relative;
    }

    /* HUD tipo MyRadar */
    .hud{
      position:absolute; top:12px; left:12px; right:12px;
      z-index:1000; display:flex; gap:10px; justify-content:space-between;
      pointer-events:none;
      font-family:Arial, sans-serif;
    }
    .chip{
      background:rgba(0,0,0,.62);
      border:1px solid rgba(255,255,255,.14);
      color:#fff;
      border-radius:16px;
      padding:10px 12px;
      min-width:140px;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      box-shadow:0 16px 40px rgba(0,0,0,.25);
    }
    .chip b{ display:block; font-size:14px; margin-bottom:2px; }
    .chip small{ opacity:.9; }

    /* Barra inferior BAJO/ALTO + hora */
    .legend{
      position:absolute; left:12px; right:12px; bottom:12px;
      z-index:1000;
      background:rgba(0,0,0,.62);
      border:1px solid rgba(255,255,255,.14);
      color:#fff;
      border-radius:16px;
      padding:10px 12px;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      box-shadow:0 16px 40px rgba(0,0,0,.25);
      font-family:Arial, sans-serif;
    }
    .bar{
      height:8px; border-radius:999px; overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(90deg,
        #08306b 0%,
        #2171b5 12%,
        #1d91c0 22%,
        #41ab5d 36%,
        #a1d99b 46%,
        #ffffb2 60%,
        #fecc5c 72%,
        #fd8d3c 82%,
        #f03b20 92%,
        #bd0026 100%);
      box-shadow: inset 0 0 10px rgba(0,0,0,.35);
    }
    .legendRow{
      margin-top:8px;
      display:flex; justify-content:space-between; align-items:center;
      font-size:13px; font-weight:700; opacity:.92;
    }
    .legendRow .mid{ font-weight:900; letter-spacing:.3px; }

    .btns{
      display:flex; gap:10px; flex-wrap:wrap;
      padding: 0 16px 16px;
      font-family:Arial, sans-serif;
    }
    button{
      border:1px solid rgba(0,0,0,.15);
      background:#f6f6f6;
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:700;
    }
  </style>
</head>

<body>
  <header>
    <h2>üì° Enviando posici√≥n GPS‚Ä¶</h2>
  </header>

  <p id="status">Esperando GPS...</p>

  <div id="wrap">
    <div id="map">
      <div class="hud">
        <div class="chip">
          <b>Radar</b>
          <small id="radarState">Cargando‚Ä¶</small>
        </div>
        <div class="chip">
          <b>GPS</b>
          <small id="gpsState">Buscando se√±al‚Ä¶</small>
        </div>
      </div>

      <div class="legend">
        <div class="bar"></div>
        <div class="legendRow">
          <div>BAJO</div>
          <div class="mid" id="radarTime">--:--</div>
          <div>ALTO</div>
        </div>
      </div>
    </div>
  </div>

  <div class="btns">
    <button id="btnCenter">Centrar</button>
    <button id="btnToggleRadar">Radar: ON</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // ===== Firebase =====
    const firebaseConfig = {
      apiKey: "AIzaSyCDHpTxxw0XObZFaG4G7VRVl8-ouszM5e8",
      authDomain: "tracker-an32b.firebaseapp.com",
      databaseURL: "https://tracker-an32b-default-rtdb.firebaseio.com",
      projectId: "tracker-an32b",
      storageBucket: "tracker-an32b.firebasestorage.app",
      messagingSenderId: "671744221089",
      appId: "1:671744221089:web:60af7fbf5e992210ec75e0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const status = document.getElementById("status");
    const gpsState = document.getElementById("gpsState");

    // ===== Mapa (Esri sat√©lite + labels) =====
    const map = L.map("map", { zoomControl: false }).setView([-12.0464, -77.0428], 7);

    L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      { maxZoom: 19 }
    ).addTo(map);

    L.tileLayer(
      "https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}",
      { maxZoom: 19, opacity: 0.95 }
    ).addTo(map);

    // Marcador azul tipo app
    const dotIcon = L.divIcon({
      className: "",
      html: `<div style="
        width:14px;height:14px;border-radius:50%;
        background:#1E90FF;border:3px solid #fff;
        box-shadow:0 6px 16px rgba(0,0,0,.35);
      "></div>`,
      iconSize: [20,20],
      iconAnchor: [10,10]
    });

    let marker = L.marker([-12.0464, -77.0428], { icon: dotIcon }).addTo(map);

    document.getElementById("btnCenter").addEventListener("click", () => {
      const ll = marker.getLatLng();
      map.setView([ll.lat, ll.lng], Math.max(map.getZoom(), 10));
    });

    // ===== Radar RainViewer ANIMADO (tipo MyRadar) =====
    let radarLayers = [];
    let radarFrames = [];
    let radarIndex = 0;
    let radarVisible = true;

    const radarState = document.getElementById("radarState");
    const radarTime = document.getElementById("radarTime");
    const btnToggleRadar = document.getElementById("btnToggleRadar");

    function fmtHHMM(unixSeconds){
      const d = new Date(unixSeconds * 1000);
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      return `${hh}:${mm}`;
    }

    async function loadRadarFrames(){
      radarState.textContent = "Cargando‚Ä¶";

      try{
        const res = await fetch("https://api.rainviewer.com/public/weather-maps.json", { cache:"no-store" });
        if(!res.ok) throw new Error("HTTP " + res.status);

        const meta = await res.json();
        radarFrames = meta?.radar?.past;
        if(!radarFrames?.length) throw new Error("Sin frames");

        // limpiar capas anteriores
        radarLayers.forEach(l => { try{ map.removeLayer(l); }catch{} });
        radarLayers = [];

        // crear capas por frame
        for (const f of radarFrames){
          const url = `https://tilecache.rainviewer.com/v2/radar/${f.time}/256/{z}/{x}/{y}/2/1_1.png`;
          const layer = L.tileLayer(url, {
            opacity: 0.88,  // fuerte (verde/amarillo/rojo se nota)
            zIndex: 999
          });
          radarLayers.push(layer);
        }

        // arrancar en el m√°s reciente
        radarIndex = radarLayers.length - 1;

        // mostrar si est√° ON
        if (radarVisible) {
          radarLayers[radarIndex].addTo(map);
          radarState.textContent = "Activo";
        } else {
          radarState.textContent = "Oculto";
        }

        radarTime.textContent = fmtHHMM(radarFrames[radarIndex].time);

      } catch(e) {
        console.log("Radar error:", e);
        radarState.textContent = "No disponible";
      }
    }

    // Cambia frame (animaci√≥n)
    const RADAR_ANIM_MS = 1100; // velocidad (ms)
    setInterval(() => {
      if (!radarVisible) return;
      if (!radarLayers.length) return;

      // quitar frame actual
      try { map.removeLayer(radarLayers[radarIndex]); } catch {}

      // siguiente frame
      radarIndex = (radarIndex + 1) % radarLayers.length;

      // mostrar nuevo frame
      try { radarLayers[radarIndex].addTo(map); } catch {}

      // hora
      radarTime.textContent = fmtHHMM(radarFrames[radarIndex].time);
    }, RADAR_ANIM_MS);

    // recargar frames cada 10 min
    loadRadarFrames();
    setInterval(loadRadarFrames, 10 * 60 * 1000);

    // Toggle radar ON/OFF
    btnToggleRadar.addEventListener("click", () => {
      radarVisible = !radarVisible;
      btnToggleRadar.textContent = `Radar: ${radarVisible ? "ON" : "OFF"}`;

      // remover todos
      radarLayers.forEach(l => { try{ map.removeLayer(l); }catch{} });

      if (radarVisible && radarLayers.length) {
        radarLayers[radarIndex].addTo(map);
        radarState.textContent = "Activo";
      } else {
        radarState.textContent = "Oculto";
      }
    });

    // ===== GPS real + env√≠o Firebase (tu c√≥digo original) =====
    navigator.geolocation.watchPosition(
      (pos) => {
        const data = {
          lat: pos.coords.latitude,
          lon: pos.coords.longitude,
          alt: pos.coords.altitude || 1000,
          time: Date.now()
        };

        // enviar a Firebase
        set(ref(db, "an32/position"), data);

        // actualizar texto
        status.innerHTML = `
          Lat: ${data.lat}<br>
          Lon: ${data.lon}<br>
          Alt: ${data.alt} m
        `;

        // actualizar mapa
        marker.setLatLng([data.lat, data.lon]);
        gpsState.textContent = `OK ‚Ä¢ ${data.lat.toFixed(3)}, ${data.lon.toFixed(3)}`;

      },
      (err) => {
        status.innerText = err.message;
        gpsState.textContent = "Error GPS";
      },
      { enableHighAccuracy: true, maximumAge: 1000, timeout: 10000 }
    );
  </script>
</body>
</html>
